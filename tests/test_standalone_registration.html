<!DOCTYPE html>
<html>
<head>
    <title>Test Registration Functions</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .tab { padding: 10px 20px; margin: 5px; cursor: pointer; border: 1px solid #ddd; }
        .tab.active { background: #007bff; color: white; }
        .form { padding: 20px; border: 1px solid #ddd; margin-top: 10px; }
        input { width: 100%; padding: 10px; margin: 5px 0; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h2>Test EverTrace Registration System</h2>
    
    <!-- Tabs -->
    <div>
        <span id="loginTab" class="tab active" onclick="showLoginForm()">ƒêƒÉng nh·∫≠p</span>
        <span id="registerTab" class="tab" onclick="showRegisterForm()">ƒêƒÉng k√Ω</span>
    </div>
    
    <!-- Login Form -->
    <div id="loginForm" class="form">
        <h3>ƒêƒÉng nh·∫≠p</h3>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <div id="loginStatus"></div>
    </div>
    
    <!-- Register Form -->
    <div id="registerForm" class="form" style="display: none;">
        <h3>ƒêƒÉng k√Ω t√†i kho·∫£n</h3>
        
        <!-- Step 1: Registration -->
        <div id="registrationStep">
            <input type="text" id="regUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p (3-20 k√Ω t·ª±)">
            <input type="email" id="regEmail" placeholder="Email c·ªßa b·∫°n">
            <input type="password" id="regPassword" placeholder="M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)">
            <input type="password" id="regConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
            <button onclick="registerUser()">G·ª≠i m√£ x√°c th·ª±c</button>
        </div>
        
        <!-- Step 2: Verification -->
        <div id="verificationStep" style="display: none;">
            <div style="background: #f0f8ff; padding: 15px; margin: 10px 0;">
                <strong>üìß Ki·ªÉm tra email c·ªßa b·∫°n</strong><br>
                Email: <span id="verificationEmail"></span>
            </div>
            <input type="text" id="verificationCode" placeholder="Nh·∫≠p m√£ x√°c th·ª±c 6 s·ªë" maxlength="6">
            <button onclick="verifyRegistration()">X√°c th·ª±c</button>
            <button onclick="resendVerificationCode()">G·ª≠i l·∫°i</button>
            <button onclick="backToRegistration()">‚Üê Quay l·∫°i</button>
        </div>
        
        <div id="registerStatus"></div>
    </div>
    
    <script>
        // Global variables
        let pendingEmail = '';
        
        // Show login form
        function showLoginForm() {
            console.log('showLoginForm() called');
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearStatus();
        }
        
        // Show register form
        function showRegisterForm() {
            console.log('showRegisterForm() called');
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registrationStep').style.display = 'block';
            document.getElementById('verificationStep').style.display = 'none';
            clearStatus();
        }
        
        // Clear status messages
        function clearStatus() {
            document.getElementById('loginStatus').innerHTML = '';
            document.getElementById('registerStatus').innerHTML = '';
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // Login function
        function login() {
            console.log('login() called');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            
            showStatus('loginStatus', 'ƒêang ƒëƒÉng nh·∫≠p...', 'info');
            
            fetch('http://localhost:8080/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            })
            .then(response => response.json())
            .then(data => {
                showStatus('loginStatus', data.message, data.success ? 'success' : 'error');
            })
            .catch(error => {
                console.error('Login error:', error);
                showStatus('loginStatus', 'L·ªói k·∫øt n·ªëi!', 'error');
            });
        }
        
        // Register user
        function registerUser() {
            console.log('registerUser() called');
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            // Validation
            if (!username || !email || !password || !confirmPassword) {
                showStatus('registerStatus', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            
            if (username.length < 3 || username.length > 20) {
                showStatus('registerStatus', 'T√™n ƒëƒÉng nh·∫≠p ph·∫£i t·ª´ 3-20 k√Ω t·ª±!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showStatus('registerStatus', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showStatus('registerStatus', 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!', 'error');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('registerStatus', 'Email kh√¥ng h·ª£p l·ªá!', 'error');
                return;
            }
            
            showStatus('registerStatus', 'ƒêang x·ª≠ l√Ω ƒëƒÉng k√Ω...', 'info');
            
            fetch('http://localhost:8080/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    email: email,
                    password: password,
                    confirm_password: confirmPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('registerStatus', data.message, 'success');
                    pendingEmail = email;
                    document.getElementById('verificationEmail').textContent = email;
                    document.getElementById('registrationStep').style.display = 'none';
                    document.getElementById('verificationStep').style.display = 'block';
                } else {
                    showStatus('registerStatus', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Registration error:', error);
                showStatus('registerStatus', 'L·ªói k·∫øt n·ªëi!', 'error');
            });
        }
        
        // Verify registration
        function verifyRegistration() {
            console.log('verifyRegistration() called');
            const verificationCode = document.getElementById('verificationCode').value.trim();
            
            if (!verificationCode || verificationCode.length !== 6) {
                showStatus('registerStatus', 'Vui l√≤ng nh·∫≠p m√£ x√°c th·ª±c 6 s·ªë!', 'error');
                return;
            }
            
            if (!pendingEmail) {
                showStatus('registerStatus', 'Kh√¥ng t√¨m th·∫•y email ƒëƒÉng k√Ω!', 'error');
                return;
            }
            
            showStatus('registerStatus', 'ƒêang x√°c th·ª±c...', 'info');
            
            fetch('http://localhost:8080/verify_registration', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: pendingEmail,
                    verification_code: verificationCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('registerStatus', data.message, 'success');
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('username').value = data.username || '';
                    }, 2000);
                } else {
                    showStatus('registerStatus', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Verification error:', error);
                showStatus('registerStatus', 'L·ªói k·∫øt n·ªëi!', 'error');
            });
        }
        
        // Resend verification code
        function resendVerificationCode() {
            console.log('resendVerificationCode() called');
            if (!pendingEmail) {
                showStatus('registerStatus', 'Kh√¥ng t√¨m th·∫•y email ƒëƒÉng k√Ω!', 'error');
                return;
            }
            
            showStatus('registerStatus', 'ƒêang g·ª≠i l·∫°i m√£...', 'info');
            
            fetch('http://localhost:8080/resend_verification', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: pendingEmail})
            })
            .then(response => response.json())
            .then(data => {
                showStatus('registerStatus', data.message, data.success ? 'success' : 'error');
            })
            .catch(error => {
                console.error('Resend error:', error);
                showStatus('registerStatus', 'L·ªói k·∫øt n·ªëi!', 'error');
            });
        }
        
        // Back to registration
        function backToRegistration() {
            console.log('backToRegistration() called');
            document.getElementById('registrationStep').style.display = 'block';
            document.getElementById('verificationStep').style.display = 'none';
            document.getElementById('verificationCode').value = '';
            document.getElementById('registerStatus').innerHTML = '';
        }
        
        // Test functions on load
        window.onload = function() {
            console.log('Page loaded. Testing functions...');
            const functions = ['showLoginForm', 'showRegisterForm', 'login', 'registerUser', 'verifyRegistration'];
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`‚úÖ ${funcName}() - OK`);
                } else {
                    console.log(`‚ùå ${funcName}() - NOT FOUND`);
                }
            });
        };
    </script>
</body>
</html>
